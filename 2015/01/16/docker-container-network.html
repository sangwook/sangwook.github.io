<!DOCTYPE html>
<html lang="ko">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  
  
  
  

  <meta name="title"       content="Docker 컨테이너 네트워크" />
  <meta name="author"      content="이상욱"/>
  <meta name="description" content="Docker Network Docker가 시작되면 docker0 이라는 이름의 virtual 인터페이스를 만들어 컨테이너와 호스트 머신이 통신한다. [1] private 범위에서 사용하지 않는 IP를 자동으로 선택해서 docker0 에 할당한다. 디폴트로 --net=bridge 옵..."/>

  <meta name="og:site_name"    content="이상욱"/>
  <meta name="og:type"         content="article"/>
  <meta name="og:title"        content="Docker 컨테이너 네트워크"/>
  <meta name="og:description"  content="Docker Network Docker가 시작되면 docker0 이라는 이름의 virtual 인터페이스를 만들어 컨테이너와 호스트 머신이 통신한다. [1] private 범위에서 사용하지 않는 IP를 자동으로 선택해서 docker0 에 할당한다. 디폴트로 --net=bridge 옵..."/>
  <meta name="og:url"          content="https://sangwook.github.io/2015/01/16/docker-container-network.html"/>
  <meta name="og:image"        content="https://sangwook.github.io/assets/2016/161011-ubuntu16-screenfetch-d309a0fce49f7abaf5a95f61a72481466e2187b8b361c52f334b03de5a55c92d.jpg"/>
  <meta name="og:image:width"  content="960"/>
  <meta name="og:image:height" content="436"/>

  <meta name="twitter:card"        content="summary_large_image"/>
  <meta name="twitter:site"        content="@yiisw">
  <meta name="twitter:creator"     content="@yiisw">
  <meta name="twitter:title"       content="Docker 컨테이너 네트워크"/>
  <meta name="twitter:description" content="Docker Network Docker가 시작되면 docker0 이라는 이름의 virtual 인터페이스를 만들어 컨테이너와 호스트 머신이 통신한다. [1] private 범위에서 사용하지 않는 IP를 자동으로 선택해서 docker0 에 할당한다. 디폴트로 --net=bridge 옵..."/>
  <meta name="twitter:image"       content="https://sangwook.github.io/assets/2016/161011-ubuntu16-screenfetch-d309a0fce49f7abaf5a95f61a72481466e2187b8b361c52f334b03de5a55c92d.jpg">

  <title>Docker 컨테이너 네트워크</title>

  <link type="text/css" rel="stylesheet" href="/assets/main-caae314880d485d51225e30ff81b77cd77bf8582dcd712eda64afdc9c886713c.css">
  <link rel="alternate" type="application/rss+xml" title="이상욱" href="http://feeds.feedburner.com/sangwook">
  <link rel="shortcut icon" href="https://avatars0.githubusercontent.com/u/123514?s=100">
</head>

  <body>
    <header class="site-header" role="banner">

  <div class="wrapper">

    <a href="/" title="sangwook">
      <span style="background-image: url('https://avatars0.githubusercontent.com/u/123514?s=100'); width:100px; height:100px; display:block;">
      </span>
    </a>

    <div class="about-desc">
      이상욱,
      scott,
      ISFP,
      <a href="https://www.facebook.com/2sangwook">facebook</a>,
      <a href="https://twitter.com/yiisw">twitter</a>,
      <a href="https://github.com/sangwook">github</a>,
      <a href="https://open.kakao.com/o/sUbQmYl">카카오톡</a>,
      <a href="https://blog.naver.com/yiisw">네이버</a>,
      <a class="page-link" href="http://feeds.feedburner.com/sangwook">RSS</a>
    </div>

  </div>

</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Docker 컨테이너 네트워크</h1>
    <p class="post-meta"><time datetime="2015-01-16T16:44:00+09:00" itemprop="datePublished">2015-01-16</time>
     <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="name" itemprop="name">이상욱</span></span></p>
  </header>
  <div class="post-content" itemprop="articleBody">
    <h3 id="docker-network">Docker Network</h3>

<ul>
  <li>Docker가 시작되면 <code class="highlighter-rouge">docker0</code> 이라는 이름의 virtual 인터페이스를 만들어 컨테이너와 호스트 머신이 통신한다. <a href='#fn:1' class='footnote' id='fnref:1'>[1]</a>
    <ul>
      <li>private 범위에서 사용하지 않는 IP를 자동으로 선택해서 <code class="highlighter-rouge">docker0</code> 에 할당한다.</li>
    </ul>
  </li>
  <li>디폴트로 <code class="highlighter-rouge">--net=bridge</code> 옵션으로 실행되며, bridge로 통신한다.
    <ul>
      <li><code class="highlighter-rouge">--net=container:NAME_or_ID</code> 옵션으로 다른 컨테이너에게 위임이 가능하다.</li>
      <li>이렇게 되면 첫번째 컨테이너와 같은 IP주소, 포트를 공유하고. loopback 인터페이스로 통신이 가능함.</li>
    </ul>
  </li>
  <li>docker run 으로 컨테이너가 시작되면.
    <ul>
      <li><code class="highlighter-rouge">docker0</code> 의 IP주소공간에서 이 컨테이너의 IP가 할당됨.</li>
      <li><code class="highlighter-rouge">docker0</code> 과 연결된 <code class="highlighter-rouge">veth*</code> 인터페이스가 만들어지고 컨테이너에 할당됨.</li>
      <li>컨테이너 쪽에서는 이게 <code class="highlighter-rouge">eth0</code> 으로 보임.</li>
      <li>내 생각에는 아래와 같이 통신하는 것으로 이해했다.
        <ul>
          <li><code class="highlighter-rouge">컨테이너1의 eth0</code> – <code class="highlighter-rouge">veth*</code> – <code class="highlighter-rouge">docker0</code> – <code class="highlighter-rouge">호스트의 eth0</code></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">--bip</code> 옵션으로 <code class="highlighter-rouge">docker0</code> 의 IP주소범위를 지정 가능함. <a href='#fn:2' class='footnote' id='fnref:2'>[2]</a></li>
  <li>Kubernetes(이하 k8s) 에서는 Docker를 실행할때 <code class="highlighter-rouge">DOCKER_OPTS="--bridge cbr0 --iptables=false"</code> 이 옵션으로 실행함. <a href='#fn:3' class='footnote' id='fnref:3'>[3]</a>
    <ul>
      <li>cbr0 은 바깥으로 나가는 트래픽을 위한 NAT역할만 하는 bridge임.</li>
      <li>bridge가 아니라 flannel <a href='#fn:4' class='footnote' id='fnref:4'>[4]</a> 을 써서 <code class="highlighter-rouge">docker0</code> 끼리 직접 연결하는 구조도 가능한 듯.</li>
    </ul>
  </li>
</ul>

<h4 id="1개의-머신-내부-컨테이너-간-통신">1개의 머신 내부 컨테이너 간 통신</h4>

<ul>
  <li>Docker에서는 iptables을 사용한다.</li>
  <li><code class="highlighter-rouge">EXPOSE</code> 로 <code class="highlighter-rouge">docker0</code> 에 포트를 노출할 수 있다.</li>
  <li>docker run 할때 <code class="highlighter-rouge">--link 컨테이너이름:별명</code> 옵션으로 다른 컨테이너와 연결할 수 있다. <a href='#fn:5' class='footnote' id='fnref:5'>[5]</a></li>
  <li>이 옵션이 하는 일은 환경변수와 /etc/hosts 에 연결정보를 추가해주는 일을 함.
    <ul>
      <li>환경변수 <code class="highlighter-rouge">별칭_PORT</code> 를 사용하여 연결 가능함.</li>
      <li><code class="highlighter-rouge">/etc/hosts</code> 를 사용하여 연결 가능함.</li>
    </ul>
  </li>
  <li>나는 보통 link를 써야할 일이 있으면 <code class="highlighter-rouge">fig</code>를 사용함. <a href='#fn:6' class='footnote' id='fnref:6'>[6]</a></li>
</ul>

<h4 id="2개-이상의-머신에서-컨테이너-간-통신">2개 이상의 머신에서 컨테이너 간 통신</h4>

<ul>
  <li>각 호스트에 Ambassador Container를 만들고. ambassador 가 forward 하는 방법. <a href='#fn:7' class='footnote' id='fnref:7'>[7]</a>
    <ul>
      <li>아래와 같이 통신한다.</li>
      <li><code class="highlighter-rouge">(consumer) --&gt; (redis-ambassador) ---network---&gt; (redis-ambassador) --&gt; (redis)</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">etcd</code> 를 사용하는 방법. <a href='#fn:8' class='footnote' id='fnref:8'>[8]</a> 글을 내가 이해한걸 짧게 요약하면
    <ul>
      <li>서비스 제공자는 연결정보를 etcd에 쓰고.</li>
      <li>서비스 소비자는 etcd에서 연결정보를 읽어서 서비스 제공자에 연결한다.</li>
    </ul>
  </li>
  <li>Docker 전용 overlay network 를 구성하는 방법.
    <ul>
      <li>모든 컨테이너를 동일 네트워크에 있는것 처럼 구성.</li>
      <li>weave <a href='#fn:9' class='footnote' id='fnref:9'>[9]</a></li>
      <li>k8s 도 이 방법을 사용.</li>
      <li>이것을 GCE가 아닌 다른 곳에서도 쓸 수 있게 만든것이 coreos의 flannel</li>
    </ul>
  </li>
</ul>

<h3 id="coreos의-flannel">coreos의 flannel</h3>

<ul>
  <li>k8s를 위해 만들어진, 각 머신 별로 subnet 을 주기위한 overlay network. <a href='#fn:10' class='footnote' id='fnref:10'>[10]</a></li>
  <li>지정한 IP주소 대역으로 각 호스트가 /24씩 잘라서 할당됨.</li>
  <li>이 정보를 etcd에 저장하고.
    <ul>
      <li>실제 IP와 매핑.</li>
    </ul>
  </li>
</ul>

<h3 id="google의-cadvisor">google의 cAdvisor</h3>

<ul>
  <li>Container Advisor 의 약자.</li>
  <li>구글이 공개함.</li>
  <li>실행중인 컨테이너들의 자원 사용량과 성능 특이점을 수집하여 컨테이너 사용자에게 보여주는 목적의 도구. <a href='#fn:11' class='footnote' id='fnref:11'>[11]</a></li>
  <li>수집해서 정보를 보내는 역할의 cadvisor daemon을 docker container들이 돌아가는 machine에 띄우면
    <ul>
      <li>해당 machine의 모니터링 정보와 해당 machine에서 돌아가는 docker container들의 정보를 아래의 방법으로 알 수 있음.</li>
      <li>웹UI (디폴트 8080포트)</li>
      <li>REST API</li>
    </ul>
  </li>
  <li>raw 데이터와 가공된 통계 데이터를 REST API로 제공함. <a href='#fn:12' class='footnote' id='fnref:12'>[12]</a></li>
  <li>공식 go client 라이브러리를 제공함. <a href='#fn:13' class='footnote' id='fnref:13'>[13]</a></li>
  <li>k8s 에서는 디폴트로 실행되고 4194포트로 통신함. <a href='#fn:14' class='footnote' id='fnref:14'>[14]</a>, <a href='#fn:15' class='footnote' id='fnref:15'>[15]</a></li>
</ul>

<p>만약 machine에 8004 포트로 cadvisor를 올렸다면, 아래와 같은 REST API로 machine에서 실행중인 docker containers 들의 cpu, network 등의 사용량을 알 수 있다.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ curl http://localhost:8004/api/v1.2/docker
{
  /docker/2f0fad0378402d0fdc2b4515ded4cca92232c2e6feec3febf27af1cfd97b9c51: {
    ...
    aliases: [mysql_1, 2f0fad0378402d0fdc2b4515ded4cca92232c2e6feec3febf27af1cfd97b9c51]
    stats: [
      { timestamp: ..., cpu: ..., memory: ..., network: ...}
      ...
    ]
  }
  /docker/602b7986fc363dab0c924acfef7ed9f2ed8c88fa7fed7fda28c98cd5b2ab4aa4: { ... }
  /docker/a73c6c51a9f7131130af31c1006ea880566a44987cc74473f3f09c8fd1b490f2: { ... }
}
</code></pre>
</div>

<div class="footnotes">  <ol>    <li>
  <div>
    <span class="num">
      <a href="#fnref:1" id="fn:1" class="reversefootnote">[1]</a>:
    </span>
    <span class="content"><a href="https://docs.docker.com/v1.2/articles/networking/">https://docs.docker.com/v1.2/articles/networking/</a> “Advanced networking - Docker Documentation” <a href="#fnref:1" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:2" id="fn:2" class="reversefootnote">[2]</a>:
    </span>
    <span class="content"><a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/design/networking.md#current-implementation">https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/design/networking.md#current-implementation</a> <a href="#fnref:2" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:3" id="fn:3" class="reversefootnote">[3]</a>:
    </span>
    <span class="content"><a href="https://github.com/coreos/flannel">https://github.com/coreos/flannel</a> <a href="#fnref:3" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:4" id="fn:4" class="reversefootnote">[4]</a>:
    </span>
    <span class="content"><a href="https://docs.docker.com/v1.2/articles/networking/#container-networking">https://docs.docker.com/v1.2/articles/networking/#container-networking</a> <a href="#fnref:4" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:5" id="fn:5" class="reversefootnote">[5]</a>:
    </span>
    <span class="content"><a href="https://docs.docker.com/userguide/dockerlinks/#container-linking">https://docs.docker.com/userguide/dockerlinks/#container-linking</a> <a href="#fnref:5" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:6" id="fn:6" class="reversefootnote">[6]</a>:
    </span>
    <span class="content"><a href="https://github.com/docker/fig">https://github.com/docker/fig</a> <a href="#fnref:6" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:7" id="fn:7" class="reversefootnote">[7]</a>:
    </span>
    <span class="content"><a href="https://docs.docker.com/articles/ambassador_pattern_linking/">https://docs.docker.com/articles/ambassador_pattern_linking/</a> <a href="#fnref:7" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:8" id="fn:8" class="reversefootnote">[8]</a>:
    </span>
    <span class="content"><a href="https://coreos.com/blog/docker-dynamic-ambassador-powered-by-etcd/">https://coreos.com/blog/docker-dynamic-ambassador-powered-by-etcd/</a> <a href="#fnref:8" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:9" id="fn:9" class="reversefootnote">[9]</a>:
    </span>
    <span class="content"><a href="https://github.com/zettio/weave">https://github.com/zettio/weave</a> <a href="#fnref:9" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:10" id="fn:10" class="reversefootnote">[10]</a>:
    </span>
    <span class="content"><a href="https://github.com/coreos/flannel">https://github.com/coreos/flannel</a> <a href="#fnref:10" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:11" id="fn:11" class="reversefootnote">[11]</a>:
    </span>
    <span class="content"><a href="https://github.com/google/cadvisor">https://github.com/google/cadvisor</a> <a href="#fnref:11" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:12" id="fn:12" class="reversefootnote">[12]</a>:
    </span>
    <span class="content"><a href="https://github.com/google/cadvisor/blob/master/docs/api.md">https://github.com/google/cadvisor/blob/master/docs/api.md</a> <a href="#fnref:12" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:13" id="fn:13" class="reversefootnote">[13]</a>:
    </span>
    <span class="content"><a href="https://github.com/google/cadvisor/tree/master/client">https://github.com/google/cadvisor/tree/master/client</a> <a href="#fnref:13" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:14" id="fn:14" class="reversefootnote">[14]</a>:
    </span>
    <span class="content"><a href="https://cloud.google.com/compute/docs/containers/container_vms#changelog">https://cloud.google.com/compute/docs/containers/container_vms#changelog</a> <a href="#fnref:14" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
    <li>
  <div>
    <span class="num">
      <a href="#fnref:15" id="fn:15" class="reversefootnote">[15]</a>:
    </span>
    <span class="content"><a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/DESIGN.md#cluster-architecture">https://github.com/GoogleCloudPlatform/kubernetes/blob/master/DESIGN.md#cluster-architecture</a> <a href="#fnref:15" class="reversefootnote"><span class="return">&#91;return&#93;</span></a></span>
  </div>
</li>
  </ol></div>
  </div>
  
</article>

      </div>
    </main>
    <footer class="site-footer">
  <div class="wrapper">

    <h2 class="footer-heading"></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col">
        이상욱,
        scott,
        ISFP,
        <a href="https://www.facebook.com/2sangwook">facebook</a>,
        <a href="https://twitter.com/yiisw">twitter</a>,
        <a href="https://github.com/sangwook">github</a>,
        <a href="https://open.kakao.com/o/sUbQmYl">카카오톡</a>,
        <a href="https://blog.naver.com/yiisw">네이버</a>,
        <a class="page-link" href="http://feeds.feedburner.com/sangwook">RSS</a>
      </div>

      <!-- <div class="footer-col footer-col-2"> -->
      <!--   <ul class="social-media-list"> -->
      <!--     <li> -->
      <!--     </li> -->
      <!--   </ul> -->
      <!-- </div> -->

      <!-- <div class="footer-col footer-col-3"> -->
      <!-- </div> -->
    </div>

  </div>
</footer>


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-26630011-3', 'auto');
  ga('send', 'pageview');
</script>



  </body>
</html>
