<!DOCTYPE html>
<html lang="ko">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  
  
  
  

  <meta name="title"       content="비슷한 이미지 검색 (Python)" />
  <meta name="author"      content="이상욱"/>
  <meta name="description" content="Detecting duplicate images using Python - The Iconfinder Blog 문제 Iconfinder는 매월 수천개의 아이콘이 올라와서 판매되는 마켓 플레이스 스타트업. 문제는 타인의 이미지를 다운받고, 그대로 올리거나 약간 수정하여 업로드 후 판..."/>

  <meta name="og:site_name"    content="이상욱"/>
  <meta name="og:type"         content="article"/>
  <meta name="og:title"        content="비슷한 이미지 검색 (Python)"/>
  <meta name="og:description"  content="Detecting duplicate images using Python - The Iconfinder Blog 문제 Iconfinder는 매월 수천개의 아이콘이 올라와서 판매되는 마켓 플레이스 스타트업. 문제는 타인의 이미지를 다운받고, 그대로 올리거나 약간 수정하여 업로드 후 판..."/>
  <meta name="og:url"          content="https://sangwook.github.io/2014/04/21/detecting-duplicate-images-using-python.html"/>
  <meta name="og:image"        content="https://sangwook.github.io/assets/2016/161011-ubuntu16-screenfetch-d309a0fce49f7abaf5a95f61a72481466e2187b8b361c52f334b03de5a55c92d.jpg"/>
  <meta name="og:image:width"  content="960"/>
  <meta name="og:image:height" content="436"/>

  <meta name="twitter:card"        content="summary_large_image"/>
  <meta name="twitter:site"        content="@yiisw">
  <meta name="twitter:creator"     content="@yiisw">
  <meta name="twitter:title"       content="비슷한 이미지 검색 (Python)"/>
  <meta name="twitter:description" content="Detecting duplicate images using Python - The Iconfinder Blog 문제 Iconfinder는 매월 수천개의 아이콘이 올라와서 판매되는 마켓 플레이스 스타트업. 문제는 타인의 이미지를 다운받고, 그대로 올리거나 약간 수정하여 업로드 후 판..."/>
  <meta name="twitter:image"       content="https://sangwook.github.io/assets/2016/161011-ubuntu16-screenfetch-d309a0fce49f7abaf5a95f61a72481466e2187b8b361c52f334b03de5a55c92d.jpg">

  <title>비슷한 이미지 검색 (Python)</title>

  <link type="text/css" rel="stylesheet" href="/assets/main-caae314880d485d51225e30ff81b77cd77bf8582dcd712eda64afdc9c886713c.css">
  <link rel="alternate" type="application/rss+xml" title="이상욱" href="http://feeds.feedburner.com/sangwook">
  <link rel="shortcut icon" href="https://avatars0.githubusercontent.com/u/123514?s=100">
</head>

  <body>
    <header class="site-header" role="banner">

  <div class="wrapper">

    <a href="/" title="sangwook">
      <span style="background-image: url('https://avatars0.githubusercontent.com/u/123514?s=100'); width:100px; height:100px; display:block;">
      </span>
    </a>

    <div class="about-desc">
      이상욱,
      scott,
      ISFP,
      <a href="https://www.facebook.com/2sangwook">facebook</a>,
      <a href="https://twitter.com/yiisw">twitter</a>,
      <a href="https://github.com/sangwook">github</a>,
      <a href="https://open.kakao.com/o/sUbQmYl">카카오톡</a>,
      <a href="https://blog.naver.com/yiisw">네이버</a>,
      <a class="page-link" href="http://feeds.feedburner.com/sangwook">RSS</a>
    </div>

  </div>

</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">비슷한 이미지 검색 (Python)</h1>
    <p class="post-meta"><time datetime="2014-04-21T10:54:00+09:00" itemprop="datePublished">2014-04-21</time>
     <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="name" itemprop="name">이상욱</span></span></p>
  </header>
  <div class="post-content" itemprop="articleBody">
    <p><a href="http://blog.iconfinder.com/detecting-duplicate-images-using-python/">Detecting duplicate images using Python - The Iconfinder Blog</a></p>

<h3 id="문제">문제</h3>

<ul>
  <li>Iconfinder는 매월 수천개의 아이콘이 올라와서 판매되는 마켓 플레이스 스타트업.</li>
  <li>문제는 타인의 이미지를 다운받고, 그대로 올리거나 약간 수정하여 업로드 후 판매해서 수익을 얻는 사용자가 생기고, 이런 사용자를 자동으로 찾아야 한다는 점.</li>
  <li>파일의 해시를 만들고, 해시를 look up 하는 방식으로 처음에는 해결했다.</li>
  <li>하지만 완전히 동일한 이미지는 이 알고리즘으로 찾을 수 있지만, 약간 변경해서 올린 이미지는 찾을 수 없다.</li>
</ul>

<p>대부분의 해시 알고리즘은 조금만 수정해도 해시값이 완전히 달라지는 문제가 있다. (아래의 코드 처럼)</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Original text.
&gt;&gt;&gt; hashlib.md5('The quick brown fox jumps over the lazy dog').hexdigest()
'9e107d9d372bb6826bd81d3542a419d6'

# Slight modification of the text.
&gt;&gt;&gt; hashlib.md5('The quick brown fox jumps over the lazy dog.').hexdigest()
'e4d909c290d0fb1ca068ffaddf22cbd0'
</code></pre>
</div>

<h3 id="해결-dhash-사용">해결 (dHash 사용)</h3>

<ul>
  <li>그래서 우리는 dHash(difference hash)를 구현했다.</li>
  <li>아래의 순서로 동작한다.</li>
</ul>

<h4 id="이미지를-흑백grayscale으로-만든다">이미지를 흑백(Grayscale)으로 만든다.</h4>

<ul>
  <li>그러면 픽셀은 0~255 를 가지는 값으로 만들어진다.</li>
</ul>

<h4 id="이미지를-공통-크기로-줄인다">이미지를 공통 크기로 줄인다.</h4>

<ul>
  <li>예를들어 9x8 로 줄이면 72개의 intensity(강도)만으로 판단할 수 있게 된다.</li>
  <li>이렇게 하면 악의적인 유저가 이미지를 확대, 축소로 약간의 조작을 했다고 해도 유사이미지 판별이 가능해진다.</li>
</ul>

<h4 id="인접-픽셀-비교">인접 픽셀 비교.</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>&gt;&gt;&gt; from PIL import Image
&gt;&gt;&gt; img = Image.open('data/cat_grumpy_orig_after_step_2.png')
&gt;&gt;&gt; width, height = img.size
&gt;&gt;&gt; pixels = list(img.getdata())
&gt;&gt;&gt; for col in xrange(width):
... print pixels[col:col+width]
...
[254, 254, 255, 253, 248, 254, 255, 254, 255]
[254, 255, 253, 248, 254, 255, 254, 255, 255]
[253, 248, 254, 255, 254, 255, 255, 255, 222]
[248, 254, 255, 254, 255, 255, 255, 222, 184]
[254, 255, 254, 255, 255, 255, 222, 184, 177]
[255, 254, 255, 255, 255, 222, 184, 177, 184]
[254, 255, 255, 255, 222, 184, 177, 184, 225]
[255, 255, 255, 222, 184, 177, 184, 225, 255]

&gt;&gt;&gt; difference = []
&gt;&gt;&gt; for row in xrange(height):
... for col in xrange(width):
... if col != width:
... difference.append(pixels[col+row] &gt; pixels[(col+row)+1])
...
&gt;&gt;&gt; for col in xrange(width-1):
... print difference[col:col+(width-1)]
...
[False, False, True, True, False, False, True, False]
[False, True, True, False, False, True, False, False]
[True, True, False, False, True, False, False, False]
[True, False, False, True, False, False, False, True]
[False, False, True, False, False, False, True, True]
[False, True, False, False, False, True, True, False]
[True, False, False, False, True, True, False, False]
[False, False, False, True, True, False, False, True]
</code></pre>
</div>

<h4 id="차이를-비트로-변환-convert-the-difference-into-bits">차이를 비트로 변환. Convert the difference into bits.</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>def dhash(image, hash_size = 8):
    # Grayscale and shrink the image in one step.
    image = image.convert('L').resize(
        (hash_size + 1, hash_size),
        Image.ANTIALIAS,
    )

    pixels = list(image.getdata())

    # Compare adjacent pixels.
    difference = []
    for row in xrange(hash_size):
        for col in xrange(hash_size):
            pixel_left = image.getpixel((col, row))
            pixel_right = image.getpixel((col + 1, row))
            difference.append(pixel_left &gt; pixel_right)

    # Convert the binary array to a hexadecimal string.
    decimal_value = 0
    hex_string = []
    for index, value in enumerate(difference):
        if value:
            decimal_value += 2**(index % 8)
        if (index % 8) == 7:
            hex_string.append(hex(decimal_value)[2:].rjust(2, '0'))
            decimal_value = 0

    return ''.join(hex_string)
</code></pre>
</div>

<h5 id="해시-비교">해시 비교</h5>

<p>파이썬에서는:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&gt;&gt;&gt; from PIL import Image
&gt;&gt;&gt; from utility import dhash, hamming_distance
&gt;&gt;&gt; orig = Image.open('data/cat_grumpy_orig.png')
&gt;&gt;&gt; modif = Image.open('data/cat_grumpy_modif.png')
&gt;&gt;&gt; dhash(orig)
'4c8e3366c275650f'
&gt;&gt;&gt; dhash(modif)
'4c8e3366c275650f'
&gt;&gt;&gt; dhash(orig) == dhash(modif)
True
</code></pre>
</div>

<p>SQL로 비교는:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>SELECT pk, hash, BIT_COUNT(
        CONV(hash, 16, 10) ^ CONV('4c8e3366c275650f', 16, 10)
    ) as hamming_distance
FROM image_hashes
HAVING hamming_distance &lt; 4
ORDER BY hamming_distance ASC;
</code></pre>
</div>

<ul>
  <li>두 값의 binary XOR 을 수행.</li>
  <li>즉, 두 값의 다른 비트의 개수를 센다.</li>
  <li>BIT_COUNT는 integer에서만 동작해서 16진수를 10진수로 변환했다.</li>
  <li>해밍거리를 기준으로 유사이미지를 판별한다.</li>
  <li><a href="http://ko.wikipedia.org/wiki/%ED%95%B4%EB%B0%8D_%EA%B1%B0%EB%A6%AC">해밍거리</a>는 string에서 오류가 난 값(또는 다른 값)의 수를 의미하는 용어인 듯.</li>
</ul>

<h3 id="추가">추가</h3>

<ul>
  <li><a href="https://www.facebook.com/groups/pythonkorea/permalink/614105852005913/">Python Korea Facebook Group 댓글</a>
    <ul>
      <li><a href="https://www.facebook.com/ditto.kim">김태호</a>: <a href="http://www.phash.org/">pHash</a>도 있습니다. <a href="http://www.phash.org/">http://www.phash.org/</a></li>
      <li><a href="https://www.facebook.com/jeyraof">이재영</a>: x,y-axis 이동과, 회전, 색깔변경도 감지할 수 있는 <a href="http://en.wikipedia.org/wiki/SURF">SURF</a>나 <a href="http://en.wikipedia.org/wiki/Scale-invariant_feature_transform">SIFT</a>도 괜찮긴 합니다. 결과물이 좀 커서 검색에 쓰기 어려울순 있지만..</li>
    </ul>
  </li>
</ul>


  </div>
  
</article>

      </div>
    </main>
    <footer class="site-footer">
  <div class="wrapper">

    <h2 class="footer-heading"></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col">
        이상욱,
        scott,
        ISFP,
        <a href="https://www.facebook.com/2sangwook">facebook</a>,
        <a href="https://twitter.com/yiisw">twitter</a>,
        <a href="https://github.com/sangwook">github</a>,
        <a href="https://open.kakao.com/o/sUbQmYl">카카오톡</a>,
        <a href="https://blog.naver.com/yiisw">네이버</a>,
        <a class="page-link" href="http://feeds.feedburner.com/sangwook">RSS</a>
      </div>

      <!-- <div class="footer-col footer-col-2"> -->
      <!--   <ul class="social-media-list"> -->
      <!--     <li> -->
      <!--     </li> -->
      <!--   </ul> -->
      <!-- </div> -->

      <!-- <div class="footer-col footer-col-3"> -->
      <!-- </div> -->
    </div>

  </div>
</footer>


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-26630011-3', 'auto');
  ga('send', 'pageview');
</script>



  </body>
</html>
